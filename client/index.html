<!doctype html>
<html>
<head>
<style>
html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font: inherit;
	vertical-align: baseline;
}
/* HTML5 display-role reset for older browsers */
article, aside, details, figcaption, figure, 
footer, header, hgroup, menu, nav, section {
	display: block;
}
body {
	line-height: 1;
}
ol, ul {
	list-style: none;
}
blockquote, q {
	quotes: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
	content: '';
	content: none;
}
table {
	border-collapse: collapse;
	border-spacing: 0;
}
/* end reset*/

body{
	font-family: Droid Sans, sans-serif;
}


#graph{
	position: absolute;
	top: -10px;
	left: 5px;
	right: 5px;
	bottom: 115px;
}

#meters{
	position: absolute;
	bottom: 0;
	height: 85px;
	left: 0;
	right: 0;
	background: #444;
	padding: 10px 10px 15px 20px;
	color: white;
}

#meters > div{
	display: inline-block;
	height: 80px;
	width: 200px;
}

#meters > div h2{
	font-variant: small-caps;
	text-transform: uppercase;
	font-weight: bold;
	font-size: 15px;
	margin: 5px 0;
}

#meters > div span{
	font-size: 40px;
}

#meters > div .reading{
	font-weight: bold;
}

#meters > div .unit{
	color: #ccc;
	font-size: 30px;
}

#meters > div small{
	display: block;
	text-transform: uppercase;
	font-weight: bold;
	font-size: 13px;
	margin-top: 5px;
}

#loading{
	position: absolute;
	top: 200px;
	text-align:center;
	font-size: 30px;
	width: 100%;
}

.reading input{
	background: transparent;
	width: 2.5em;
	font-size: inherit;
	font-weight: inherit;
	color: inherit;
	border: 0;
	padding: 0;
	margin: 0;
}

.reading input.negative{
	width: 2.86em;
	margin-left: -0.36em;
}

.reading h2:-webkit-drag{
	background: white;
	color: black;
	font-size: 200%;
}

</style>
<link rel='stylesheet' href='livegraph.css' />


<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js'></script>
<script src='livegraph.js'></script>
<script src='raphael-min.js'></script>

</head>
<body>
<div id='wrap'>

<div id='graph'>

</div>

<div id='loading'>Connecting...</div>

<div id='meters'>

</div>
</div>

<script>
var meters={};
var metersByName = {};

function addMeter(m){
	metersByName[m.name] = m;	
	m.div = $("<div>")
		.append(m.h2 = $("<h2>").text(m.displayname))
		.append($("<span class='reading'>")
			.append(m.input = $("<input>")))
		.append(m.unit = $("<span class='unit'>").text(m.units))
		.append($("<small>"))
		.appendTo('#meters');
	
	m.input.change(function(e){
		msg = {'_action':'set'}
		msg[m.name] = parseFloat($(m.input).val(), 10)
		ws.send(JSON.stringify(msg))
		$(m.input).blur()
		console.log('sent', m.name)
	});
	
	m.h2.get(0).draggable = true;
	m.h2.get(0).ondragstart = function(e){
		e.dataTransfer.setData('text/plain', m.name)
	}

}

function setup_dnd_target(axisconfig){
	var elem = axisconfig.labelDiv;
	elem.ondragover = function(e){
	 	e.preventDefault()
	}
	elem.ondrop = function(e){
		var channel = e.dataTransfer.getData('text/plain')
		bindAxis(axisconfig, channel);
		e.preventDefault()
		return false
	}
}

function bindAxis(axis, channel){
	var meter=metersByName[channel];
	graph.setAxis(axis, meter.displayname + ' ('+meter.units+')', meter.name, meter.axisMin, meter.axisMax, axis.color)
}

function updateAxis(axisconfig, defaultchan){
	if (!axisconfig.name || !meters[axisconfig.name]){
		bindAxis(axisconfig, defaultchan);
	}else{
		bindAxis(axisconfig, axisconfig.name);
	}
}

function configChannels(s){
	meters = s;
	$('#meters').empty()
	
	for (var i=0; i<meters.length; i++){
		addMeter(meters[i]);
	}
	graph.axes.yleft.color = 'blue'
	graph.axes.yright.color = 'red'
	updateAxis(graph.axes.xbottom, 'time');
	updateAxis(graph.axes.yleft, 'voltage');
	updateAxis(graph.axes.yright, 'current');
}

var renderTime = 0;
var renders = 0;
var lastDriving = null;

function update(data){
	for (var i=0; i<meters.length; i++){
		var m = meters[i]
		if (data[m.name] !== undefined){
			setInput(m.input, data[m.name])
		}
		
		if (data._driving != lastDriving){
			if (m.name == data._driving){
				$(m.div).find('small').text("Source")
			}else if (m.name != 'time'){
				$(m.div).find('small').text("Measure")
			}else{
				$(m.div).find('small').text("Live")
			}
		}
	}
	
	var t1 =new Date()
	graph.pushData(data)
	var t2 = new Date()
	
	renderTime += t2 - t1
	renders++; 
}

if(console){
	setInterval(function(){console.log('avg:', renderTime/renders); renderTime=renders=0}, 5000);
}

/* URL params */

var key, pair, params, _i, _len, _ref, _ref2;

params = {};

_ref = document.location.search.slice(1).split('&');

for (_i = 0, _len = _ref.length; _i < _len; _i++) {
 pair = _ref[_i];
 _ref2 = pair.split('='), key = _ref2[0], params[key] = _ref2[1];
}

var hostname = params.server || document.location.host
var ws;

var xspan = 30;
var setup = false;

function setInput(input, number){
	if (!input.is(':focus')){
		input.val(number.toFixed(3))
		if (number < 0){
			input.addClass('negative');
		}else{
			input.removeClass('negative');
		}
	}
}


$(document).ready(function(){
	graph = new LiveGraph_canvas(document.getElementById('graph'));
	
	setup_dnd_target(graph.axes.xbottom);
	setup_dnd_target(graph.axes.yleft);
	setup_dnd_target(graph.axes.yright);
	
	
	ws = new WebSocket("ws://" + hostname + "/dataws");
     
    ws.onopen = function(){
        document.title = "Nonolith Client (Connected)"
        document.body.className = "connected"
        
        
        $('#loading').text("Waiting for data...")
		setup = false;
		if (reconnectTimer){
			reconnectTimer = false;
			clearInterval(reconnectTimer);
		}
    };
    
    ws.onmessage = function (evt){
		m = JSON.parse(evt.data)
		if (m._action == 'update'){
	 		if (!setup){
		 		$('#loading').hide()
		 		setup = true
	 		}
			update(m)
		}else if(m._action == 'config'){
			configChannels(m.channels)
		}
    };
    
    ws.onclose = function(){ 
        document.title = "Nonolith Client(Disconnected)"
        document.body.className = "disconnected"
        $('#loading').text('Disconnected').show()
		// setInterval(tryReconnect, 1000);
    };
	
	$(window).resize(function(){graph.resized()})
}) 
</script>

</body>
</html>
