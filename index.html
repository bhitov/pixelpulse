<!doctype html>
<html>
<head>
<style>
html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font: inherit;
	vertical-align: baseline;
}
/* HTML5 display-role reset for older browsers */
article, aside, details, figcaption, figure, 
footer, header, hgroup, menu, nav, section {
	display: block;
}
body {
	line-height: 1;
}
ol, ul {
	list-style: none;
}
blockquote, q {
	quotes: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
	content: '';
	content: none;
}
table {
	border-collapse: collapse;
	border-spacing: 0;
}
/* end reset*/

body{
	font-family: Droid Sans; sans-serif;
}


#graph{
	position: absolute;
	top: 10px;
	left: 10px;
	right: 10px;
	bottom: 105px;
}

#meters{
	position: absolute;
	bottom: 0;
	height: 85px;
	left: 0;
	right: 0;
	background: #444;
	padding: 10px 10px 15px 20px;
	color: white;
}

#meters > div{
	display: inline-block;
	height: 80px;
	width: 200px;
}

#meters > div h2{
	font-variant: small-caps;
	text-transform: uppercase;
	font-weight: bold;
	font-size: 15px;
	margin: 5px 0;
}

#meters > div span{
	font-size: 40px;
}

#meters > div .reading{
	font-weight: bold;
}

#meters > div .unit{
	color: #ccc;
	font-size: 30px;
}

#meters > div small{
	display: block;
	text-transform: uppercase;
	font-weight: bold;
	font-size: 13px;
	margin-top: 5px;
}

#loading{
	position: absolute;
	top: 200px;
	text-align:center;
	font-size: 30px;
	width: 100%;
}

.reading input{
	background: transparent;
	width: 2.5em;
	font-size: inherit;
	font-weight: inherit;
	color: inherit;
	border: 0;
	padding: 0;
	margin: 0;
}

.reading input.negative{
	width: 2.86em;
	margin-left: -0.36em;
}

</style>

<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js'></script>
<script src='protovis.min.js'></script>
<script src="/socket.io/socket.io.js"></script> 

</head>
<body>
<div id='wrap'>

<div id='graph'></div>

<div id='loading'>Connecting...</div>

<div id='meters'>

</div>
</div>

<script>

var meters={};

function addMeter(key, m){	
	m.div = $("<div>")
		.append($("<h2>").text(m.displayname))
		.append($("<span class='reading'>")
			.append(m.input = $("<input>")))
		.append(m.unit = $("<span class='unit'>").text(m.units))
		.append($("<small>").text("Unknown"))
		.appendTo('#meters');
	
	m.input.change(function(e){
		m = {'_action':'set'}
		m[key] = $(m.input).val() 
		socket.send(m)
		m.input.blur()
	});

}

function configChannels(s){
	meters = s;
	$('#meters').empty()
	
	for (i in meters){
		if (i[0] == '_') continue;
		addMeter(i, meters[i]);
	}
}

function update(data){
	for (key in meters){
		var m = meters[key];
		if (data[key]){
			setInput(m.input, data[key])
		}
	}
}

var w=600, h=300;

var x = pv.Scale.linear(-10, 10).nice()
var y = pv.Scale.linear(-10, 10).nice()
var y2 = pv.Scale.linear(-200, 200).nice()

var data = [];

var vis = new pv.Panel()
			.bottom(20)
			.left(30)
			.right(30)
			.top(5)
			.canvas('graph')

function resize(){
	w = $("#graph").width() - 50;
	h = $("#graph").height() - 25;
	vis.width(w).height(h);
	x = x.range(0,w);
	y = y.range(0,h);
	y2 = y2.range(0,h); 
	console.log('resized');
}

$(window).resize(resize);
						
yt = vis.add(pv.Rule)
    .data(y.ticks(5))
    .bottom(y)
    .strokeStyle(function(d){return d ? "#ccc" : "#000"})
	.anchor("left").add(pv.Label)
    	.text(y.tickFormat)
    	.textStyle('blue')
    
yt2 = vis.add(pv.Rule)
    .data(y2.ticks(5))
    .bottom(y2)
    .strokeStyle('rgba(0,0,0,0)')
	.anchor("right").add(pv.Label)
  		.text(y2.tickFormat)
  		.textStyle('red')

panel = vis.add(pv.Panel)
    .overflow("hidden")
    
panel.add(pv.Line)
			.data(function(){return data})
			.left(function(d){return x(d.time)})
			.bottom(function(d){return y(d.voltage)})
			.lineWidth(3)
			.strokeStyle('blue')
			
panel.add(pv.Line)
			.data(function(){return data})
			.left(function(d){return x(d.time)})
			.bottom(function(d){return y2(d.current)})
			.lineWidth(3)
			.strokeStyle('red')

var acc = 0;

var socket = new io.Socket(); 
socket.connect();

socket.on('connect', function(){
	$('#loading').text("Waiting for data...")
	$(document.body).css('background', 'transparent')
	$('#reconnect').hide()
	setup = false;
	if (reconnectTimer){
		reconnectTimer = false;
		clearInterval(reconnectTimer);
	}
})

socket.on('disconnect', function(){
	$('#loading').text('Disconnected').show()
	setInterval(tryReconnect, 1000);
})
	

var reconnectTimer = false;
function tryReconnect(){
	socket.connect()
}

var xspan = 30;
var setup = false;

function setInput(input, number){
	if (!input.is(':focus')){
		input.val(number.toFixed(3))
		if (number < 0){
			input.addClass('negative');
		}else{
			input.removeClass('negative');
		}
	}
}

socket.on('message', function(m){ 	
	if (!setup){
 		$('#loading').hide()
 		resize();
 		setup = true
 	}
 	
 	if (m._action == 'update'){
		update(m)
	
	  	xmax = m.time
	  	xmin = xmax - xspan;
	  	x.domain(xmin, xmax).range(0, w);
	  	data.push(m)
	  	
	  	while(data[0].time<xmin) data.shift()
	  	
		vis.render()
	}else if(m._action == 'configChannels'){
		configChannels(m)
	}
 }) 
</script>

</body>
</html>
